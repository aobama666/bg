<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sgcc.bg.mapper.SyncProjectMapper">

	<select id="queryProjectNoteInfo" resultType="java.util.Map">
		SELECT       DISTINCT  N.DEPTCODE  ,
		                         D.DEPTNAME
	    FROM    BG_SYNC_PROJECT_NOTE   N
	    LEFT JOIN BG_SYS_DEPT   D   ON D.DEPTCODE = N.DEPTCODE  where  N.VALID='1'  AND   N.PROJECT_TYPE=#{ProjectType}
	</select>

	<select id="queryDataDictionaryInfo" resultType="java.util.Map">
		SELECT  CODE,NAME  from  BG_SYS_DATADICTIONARY  where VAILD='1'  and  PID = #{pid}   ORDER BY SORT_ID DESC
	</select>

	<select id="queryDeptInfo" resultType="java.util.Map">
        SELECT  *  from  BG_SYS_DEPT  where VALID='1'  and  DEPTCODE = #{deptCode}
	</select>

	<select id="queryAuditoriginInfo" resultType="java.util.Map">
		SELECT  SYSNAME,SYSKEY  from  BG_SYS_AUDITORIGIN  where   SYSNAME = #{key}
	</select>


	<select id="queryProjectInfo" resultType="java.util.Map">
		SELECT   DISTINCT projectId   as  "projectId",
		                    projectNumber  as  "projectNumber",
		                    projectName  as  "projectName",
		                    wbsNumber   as  "wbsNumber",
		                    year  as "year",
		                    month  as "month" ,
		                    projectGrade  as "projectGrade",
		                    deptCode  as "deptCode"
		FROM(
		SELECT
		A.PROJECT_ID  as  projectId,
		A.projectNumber,
		A.projectName,
		A.wbsNumber,
		A.year,
		A.month,
		A.projectGrade,
		A.WORK_TIME_BEGIN,
		A.WORK_TIME_END,
		B.TYPE ,
		B.PDEPTCODE  as  pdeptNumber,
		B.DEPTCODE  as  deptNumber,
		DECODE (B.TYPE,
		'2',DECODE (A.projectGrade,'YJ','','BMJ',B.PDEPTCODE,'CSJ',B.DEPTCODE) ,
		'1',B.DEPTCODE) as deptCode
		FROM (
		SELECT
		T.PROJECT_ID,
		P.PROJECT_NUMBER   AS  projectNumber,
		P.PROJECT_NAME     AS  projectName,
		P.WBS_NUMBER   AS   wbsNumber,
		TO_CHAR(T.WORK_TIME_END, 'yyyy') as year,
		TO_CHAR(T.WORK_TIME_END, 'MM') as month,
		T.WORK_TIME_BEGIN,
		T.WORK_TIME_END,
		T.WORKING_HOUR,
		P.PROJECT_GRADE  as projectGrade
		FROM BG_WORKINGHOUR_INFO T
		LEFT JOIN BG_PROJECT_INFO P
		ON P.ID = T.PROJECT_ID
		WHERE T.VALID = 1    AND   P.STATUS=1
		)  A   LEFT JOIN
		(
		SELECT
		D.SRC,D.EXP_START_TIME,D.EXP_END_TIME,
		D1.DEPTCODE,D1.DEPTNAME,D1.TYPE,D1.PDEPTCODE  ,PU.PROJECT_ID ,PU.START_DATE,PU.END_DATE
		FROM    BG_PROJECT_USER    PU
		LEFT JOIN BG_SYS_USER U  ON PU.HRCODE = U.HRCODE
		LEFT JOIN BG_SYS_USER_DEPT_RELATION D  ON U.USERID = D.USERID
		LEFT JOIN BG_SYS_DEPT D1  ON D.DEPTID = D1.DEPTID
		where   PU.STATUS='1'  AND  PU.ROLE='1'  and  D.VALID='1'
		)  B    ON      A.PROJECT_ID=B.PROJECT_ID   and   B.START_DATE  &lt;= A.WORK_TIME_END 	and   B.END_DATE &gt;= A.WORK_TIME_END
		and   B.EXP_START_TIME  &lt;= A.WORK_TIME_END 	and   B.EXP_END_TIME &gt;= A.WORK_TIME_END
		)  where  1=1
		<if  test="beginDate!= null and beginDate!= ''">
			AND WORK_TIME_BEGIN   &gt;=    TO_DATE( #{beginDate}, 'yyyy-MM-dd')
		</if>
		<if  test="endDate!= null and endDate!= ''">
			AND WORK_TIME_END     &lt;=     TO_DATE( #{endDate}, 'yyyy-MM-dd')
		</if>
		<if  test="projectType!= null and projectType!= ''">
			and   projectGrade = #{projectType}
		</if>
		<if  test="deptCode!= null and deptCode!= ''">
			and   deptCode = #{deptCode}
		</if>
	</select>







	<insert id="addProjectNode"  parameterType="java.util.HashMap">
		INSERT INTO BG_SYNC_PROJECT_NOTE (
		UUID,
		BEGINDATE,
		ENDDATE,
		PROJECT_TYPE,
		DEPTCODE,
        CREATE_DATE,
        UPDATE_DATE,
        CREATE_USER,
        UPDATE_USER,
        VALID,
        KEY,
        BATCHID
		)
		VALUES(
		#{projectNode.id},
		#{projectNode.beginDate},
		#{projectNode.endDate},
		#{projectNode.projectType},
		#{projectNode.deptCode},
		#{projectNode.createTime},
		#{projectNode.updateTime},
		#{projectNode.createUser},
		#{projectNode.updateUser},
		#{projectNode.valid},
		#{projectNode.key},
		#{projectNode.batchId}
		)
	</insert>

	<insert id="addProjectInfo"  parameterType="java.util.HashMap">
		INSERT INTO BG_SYNC_PROJECT (
		UUID,
		PROJECT_ID,
		PROJECT_NUMBER,
		PROJECT_NAME,
		WBS_NUMBER,
		YEAR,
		MONTH,
		PROJECT_GRADE,
		DEPTCODE,
		PROJECT_NOTEID,
		CREATE_DATE,
        UPDATE_DATE,
        CREATE_USER,
        UPDATE_USER,
        VALID
		)
		VALUES(
		#{projectInfo.uuid},
		#{projectInfo.projectId},
		#{projectInfo.projectNumber},
		#{projectInfo.projectName},
		#{projectInfo.wbsNumber},
		#{projectInfo.year},
		#{projectInfo.month},
		#{projectInfo.projectGrade},
		#{projectInfo.deptCode},
		#{projectInfo.projectNodeId},
		#{projectInfo.createTime},
		#{projectInfo.updateTime},
		#{projectInfo.createUser},
		#{projectInfo.updateUser},
		#{projectInfo.valid}
		)
	</insert>

	<sql id="projectNoteInfo">
		SELECT
		N.UUID,
		N.BEGINDATE,
		N.ENDDATE,
		N.PROJECT_TYPE,
		DECODE(N.PROJECT_TYPE,'YJ','院级','BMJ','部门级','CSJ','处室级') PROJECT_TYPE_NAME,
		N.DEPTCODE,
		TO_CHAR(N.CREATE_DATE,'YYYY-MM-DD HH:MI:SS')  CREATE_DATE,
		D.DEPTNAME,
		N.BATCHID
		FROM    BG_SYNC_PROJECT_NOTE   N
		LEFT JOIN BG_SYS_DEPT   D   ON D.DEPTCODE = N.DEPTCODE  where  N.VALID='1'
		<if  test="projectNode.beginDate!= null and projectNode.beginDate!= ''">
			AND TO_DATE(N.BEGINDATE, 'yyyy-MM-dd')   &gt;=    TO_DATE( #{projectNode.beginDate}, 'yyyy-MM-dd')
		</if>
		<if  test="projectNode.endDate!= null and projectNode.endDate!= ''">
			AND TO_DATE(N.ENDDATE, 'yyyy-MM-dd')      &lt;=     TO_DATE( #{projectNode.endDate}, 'yyyy-MM-dd')
		</if>
		<if  test="projectNode.projectType!= null and projectNode.projectType!= ''">
			AND N.PROJECT_TYPE     =      #{projectNode.projectType}
		</if>
		<if  test="projectNode.deptCode!= null and projectNode.deptCode!= ''">
			AND N.DEPTCODE     =      #{projectNode.deptCode}
		</if>
		ORDER BY N.CREATE_DATE  DESC
	</sql>

	<select id="selectProjectNoteInfo" resultType="java.util.Map">
			SELECT  T.*  from(
			SELECT  TB.* , ROWNUM AS ROWNO  from(
			<include refid="projectNoteInfo"/>
			) TB  WHERE #{projectNode.page_end} >= ROWNUM
			) T   WHERE T.ROWNO > #{projectNode.page_start}
	</select>

	<select id="selectProjectNoteInfoNum" resultType="java.lang.String" parameterType="java.util.HashMap" >
		SELECT    COUNT(1)  AS "countNum"  from(<include refid="projectNoteInfo"/>)
	</select>





	<sql id="projectDetailsInfo">
		SELECT
		P.UUID,
		P.PROJECT_ID,
		P.PROJECT_NUMBER,
		P.PROJECT_NAME,
		P.WBS_NUMBER,
		P.YEAR,
		P.MONTH,
		P.PROJECT_GRADE,
		DECODE(P.PROJECT_GRADE,'YJ','院级','BMJ','部门级','CSJ','处室级') PROJECT_GRADE_NAME,
		P.DEPTCODE,
		D.DEPTNAME,
		N.BEGINDATE,
		N.ENDDATE,
		P.PROJECT_NOTEID
		FROM    BG_SYNC_PROJECT   P
		LEFT JOIN BG_SYS_DEPT   D   ON D.DEPTCODE = P.DEPTCODE
		LEFT JOIN BG_SYNC_PROJECT_NOTE   N   ON N.UUID = P.PROJECT_NOTEID
		where  P.VALID='1'
		<if  test="projectDetails.year!= null and projectDetails.year!= ''">
			AND P.YEAR     =      #{projectDetails.year}
		</if>
		<if  test="projectDetails.month!= null and projectDetails.month!= ''">
			AND P.MONTH     =      #{projectDetails.month}
		</if>
		<if  test="projectDetails.projectName!= null and projectDetails.projectName!= ''">
			AND P.PROJECT_NAME like '%'||#{projectDetails.projectName}||'%'
		</if>
		<if  test="projectDetails.projectNumber!= null and projectDetails.projectNumber!= ''">
			AND P.PROJECT_NUMBER like '%'||#{projectDetails.projectNumber}||'%'
		</if>
		<if  test="projectDetails.wbsNumber!= null and projectDetails.wbsNumber!= ''">
			AND P.WBS_NUMBER like '%'||#{projectDetails.wbsNumber}||'%'
		</if>
		<if  test="projectDetails.noteId!= null and projectDetails.noteId!= ''">
			AND P.PROJECT_NOTEID     =      #{projectDetails.noteId}
		</if>
		ORDER BY P.YEAR ,P.MONTH,P.PROJECT_NAME
	</sql>

	<select id="selectProjectDetailsInfo" resultType="java.util.Map">
		SELECT  T.*  from(
		SELECT  TB.* , ROWNUM AS ROWNO  from(
		<include refid="projectDetailsInfo"/>
		) TB  WHERE #{projectDetails.page_end} >= ROWNUM
		) T   WHERE T.ROWNO > #{projectDetails.page_start}
	</select>

	<select id="selectProjectDetailsInfoNum" resultType="java.lang.String" parameterType="java.util.HashMap" >
		SELECT    COUNT(1)  AS "countNum"  from(<include refid="projectDetailsInfo"/>)
	</select>

	<select id="selectForProjectNumber" resultType="java.util.Map"   >
		SELECT
		DISTINCT	 PROJECT_NUMBER
		from(<include refid="projectDetailsInfo"/>)
	</select>

	<select id="selectForWbsNumber" resultType="java.util.Map"   >
		SELECT
		DISTINCT   WBS_NUMBER
		from(<include refid="projectDetailsInfo"/>)


	</select>


</mapper>