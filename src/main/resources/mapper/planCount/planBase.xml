<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sgcc.bg.planCount.mapper.PlanBaseMapper">

    <!--专项和院内项目类型数据维护公共sql-->
    <sql id="CategoryInfo">
        SELECT  ID,
        SPECIAL_NAME,
        SPECIAL_CODE
        FROM   PS_SPECIAL_CATEGORY
        where   1=1
        <if test="categoryMap.specalType!= null and categoryMap.specalType!= ''">
            and   SPECIAL_TYPE  = #{categoryMap.specalType}
        </if>
        <if test="categoryMap.specalCode!= null and categoryMap.specalCode!= ''">
            and   SPECIAL_CODE  = #{categoryMap.specalCode}
        </if>
        <if test="categoryMap.specalName!= null and categoryMap.specalName!= ''">
            and   SPECIAL_NAME  = #{categoryMap.specalName}
        </if>
        ORDER BY  SPECIAL_CODE
    </sql>
    <!--专项和院内项目类型数据维护公共sql-->
    <select id="selectForCapitalCategoryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
            SELECT  SC.ID,
            SC.SPECIAL_NAME,
            SC.SPECIAL_CODE
            FROM   PS_SPECIAL_CATEGORY  SC
            LEFT JOIN  PS_FUNDS_SOURCE  FS ON  SC.SPECIAL_CODE=FS.SPECIAL_COMPANY_CODE
            LEFT JOIN  PS_SPECIAL_CATEGORY  SC1 ON  SC1.SPECIAL_CODE=FS.SPECIAL_EPRI_CODE
            where   1=1
            <if test="categoryMap.specalType!= null and categoryMap.specalType!= ''">
                and   SC.SPECIAL_TYPE  = #{categoryMap.specalType}
            </if>
            <if test="categoryMap.specalCode!= null and categoryMap.specalCode!= ''">
                and   SC.SPECIAL_CODE  = #{categoryMap.specalCode}
            </if>
            <if test="null != categoryMap.epriCodes and categoryMap.epriCodes.size > 0">
                and   FS.SPECIAL_EPRI_CODE IN
                <foreach collection="categoryMap.epriCodes" item="epriCode" open="(" separator="," close=")">
                    #{epriCode,jdbcType=VARCHAR}
                </foreach>
            </if>
            ORDER BY   SC.SPECIAL_CODE
    </select>

    <!-- 专项和院内项目类型的查询-->
    <select id="selectForCategoryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="CategoryInfo"/>)
    </select>



    <!--资金来源维护公共sql-->
    <sql id="FundsSourceInfo">
        SELECT  FS.ID,
        FS.FUNDS_SOURCE_CODE,
        FS.FUNDS_SOURCE_NAME,
        FS.SPECIAL_COMPANY_CODE,
        FS.SPECIAL_EPRI_CODE,
        SC.SPECIAL_CODE,
        SC.SPECIAL_NAME
        FROM   PS_FUNDS_SOURCE  FS
        LEFT JOIN  PS_SPECIAL_CATEGORY SC  ON  SPECIAL_COMPANY_CODE=SC.SPECIAL_CODE
        where   1=1
        <if test="fundsSourceMap.specalType!= null and fundsSourceMap.specalType!= ''">
            and    FS.SPECIAL_COMPANY_CODE  = #{fundsSourceMap.specalType}
        </if>
        <if test="fundsSourceMap.specialName!= null and fundsSourceMap.specialName!= ''">
            and    SC.SPECIAL_NAME  = #{fundsSourceMap.specialName}
        </if>
        <if test="fundsSourceMap.specialCode!= null and fundsSourceMap.specialCode!= ''">
            and    SC.SPECIAL_CODE  = #{fundsSourceMap.specialCode}
        </if>
        <if test="null != fundsSourceMap.epriCodes and fundsSourceMap.epriCodes.size > 0">
            and   FS.SPECIAL_EPRI_CODE IN
            <foreach collection="fundsSourceMap.epriCodes" item="epriCode" open="(" separator="," close=")">
                #{epriCode,jdbcType=VARCHAR}
            </foreach>
        </if>
    ORDER BY  FUNDS_SOURCE_CODE
    </sql>

    <!-- 资金来源的查询-->
    <select id="selectForFundsSourceInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="FundsSourceInfo"/>)
    </select>



    <!--承担单位的查询-->
    <sql id="CommitmentUnitInfo">
        SELECT  DISTINCT
        PROFIT_CENTER_CODE,
        PROFIT_CENTER_DEATIL
        FROM   PS_PROFIT_CENTER
        where  1=1
        <if test="commitmentUnitMap.commitmentUnit!= null and commitmentUnitMap.commitmentUnit!= ''">
            and   PROFIT_CENTER_CODE  = #{commitmentUnitMap.commitmentUnit}
        </if>
    </sql>
    <!-- 基础数据中存在的承担单位的查询-->
    <select id="selectForCommitmentUnitInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="CommitmentUnitInfo"/>)
    </select>


    <select id="selectForDataDictionaryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     PID,PCODE,NAME,CODE,SORT_ID  from      BG_SYS_DATADICTIONARY  where 1=1
        <if test="dataDictionaryMap.pcode!= null and dataDictionaryMap.pcode!= ''">
            and   PCODE  = #{dataDictionaryMap.pcode}
        </if>
        <if test="dataDictionaryMap.pid!= null and dataDictionaryMap.pid!= ''">
            and   PID  = #{dataDictionaryMap.pid}
        </if>
        ORDER BY  to_number(SORT_ID)
    </select>


    <!--计划执行数据维护公共sql-->
    <sql id="yearBaseInfo">
        SELECT  PTIME as  YEAR , SUM(ZGSZTZ)  as TOTAL_INVEST,SUM(WERT1) as YEAR_INVEST ,count(PSPID) as NUMBER_OF_ITEMS ,SUM(DECODE(ZZJXZ,'00001',ZGSZTZ,'0')) AS  CAPITAL_INVEST,SUM(DECODE(ZZJXZ,'00002',ZGSZTZ,'0')) AS  COST_INVEST  from(
        SELECT
        Z1.PSPID,
        Z1.PTIME,
        Z1.ZGSZTZ,
        Z1.WERT1,
        DECODE(Z1.ZZJXZ,'00001','00001','00002','00002',''  )as ZZJXZ,
        Z1.ZZJXZ_T,
        Z1.PRCTR,
        ER.SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME  as SPECIAL_COMPANY_NAME
        FROM   ZTPSJHTJ001    Z1
        LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
        LEFT JOIN     PS_SPECIAL_CATEGORY  SC  ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
        UNION ALL
        SELECT
        MY.ID  as PSPID,
        MY.YEAR  as  PTIME,
        0 ZGSZTZ,
        TO_NUMBER(MY.PLAN_AMOUNT)  as  WERT1,
        DECODE(MY.SPECIAL_TYPE, 'C013','00001', 'C014', '00001', 'C012', '00002'  ,    '' ) as ZZJXZ,
        DECODE(MY.SPECIAL_TYPE, 'C013','资本化', 'C014', '资本化', 'C012', '成本化', '' ) as  ZZJXZ_T,
        null PRCTR,
        MY.SPECIAL_TYPE   as SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME   as SPECIAL_COMPANY_NAME
        FROM      PS_MAINTAIN_YEAR  MY
        LEFT JOIN    PS_SPECIAL_CATEGORY  SC ON   MY.SPECIAL_TYPE=SC.SPECIAL_CODE
        ) where 1=1  and  ZZJXZ IS NOT NULL
        <if test="baseMap.year!= null and baseMap.year!= ''">
            and   PTIME  = #{baseMap.year}
        </if>
        <if test="baseMap.specialType!= null and baseMap.specialType!= ''">
            and   SPECIAL_COMPANY_CODE  = #{baseMap.specialType}
        </if>
        GROUP BY  PTIME
    </sql>

    <select id="selectForYearInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT  *   from(<include refid="yearBaseInfo"/>) where 1=1     ORDER BY   YEAR
    </select>




    <sql id="itemBaseInfo">
        SELECT  PTIME as  YEAR ,   SPECIAL_COMPANY_CODE  as  SPECIAL_CODE,SPECIAL_COMPANY_NAME as  SPECIAL_NAME , SUM(ZGSZTZ)  as TOTAL_INVEST,SUM(WERT1) as YEAR_INVEST ,count(PSPID) as NUMBER_OF_ITEMS    from(
        SELECT
        Z1.PSPID,
        Z1.PTIME,
        Z1.ZGSZTZ,
        Z1.WERT1,
        DECODE(Z1.ZZJXZ,'00001','00001','00002','00002',''  )as ZZJXZ,
        Z1.ZZJXZ_T,
        Z1.PRCTR,
        ER.SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME  as SPECIAL_COMPANY_NAME
        FROM   ZTPSJHTJ001    Z1
        LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
        LEFT JOIN     PS_SPECIAL_CATEGORY  SC  ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
        UNION ALL
        SELECT
        MY.ID  as PSPID,
        MY.YEAR  as  PTIME,
        0 ZGSZTZ,
        TO_NUMBER(MY.PLAN_AMOUNT)  as  WERT1,
        DECODE(MY.SPECIAL_TYPE, 'C013','00001', 'C014', '00001', 'C012', '00002'  ,    '' ) as ZZJXZ,
        DECODE(MY.SPECIAL_TYPE, 'C013','资本化', 'C014', '资本化', 'C012', '成本化', '' ) as  ZZJXZ_T,
        null PRCTR,
        MY.SPECIAL_TYPE   as SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME   as SPECIAL_COMPANY_NAME
        FROM      PS_MAINTAIN_YEAR  MY
        LEFT JOIN    PS_SPECIAL_CATEGORY  SC ON   MY.SPECIAL_TYPE=SC.SPECIAL_CODE
        ) where 1=1  and  SPECIAL_COMPANY_CODE IS NOT NULL
        <if test="baseMap.year!= null and baseMap.year!= ''">
            and   PTIME  = #{baseMap.year}
        </if>
        <if test="null != baseMap.specialTypes and baseMap.specialTypes.size > 0">
            and   SPECIAL_COMPANY_CODE IN
            <foreach collection="baseMap.specialTypes" item="specialType" open="(" separator="," close=")">
                #{specialType,jdbcType=VARCHAR}
            </foreach>
        </if>
        GROUP BY  PTIME  ,SPECIAL_COMPANY_CODE,SPECIAL_COMPANY_NAME
    </sql>


    <select id="selectForItemInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT  *   from(<include refid="itemBaseInfo"/>) where 1=1     ORDER BY   SPECIAL_CODE
    </select>

</mapper>