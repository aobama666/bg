<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sgcc.bg.planCount.mapper.PlanBaseMapper">
    <!-- 年份的查询-->
    <select id="selectForBaseYearInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT  YEAR as  "year" ,ROWNUM     FROM(
        SELECT   DISTINCT   PTIME   as  YEAR       FROM PS_ERP_PROJECT_INFO     ORDER BY  PTIME DESC
        )   where  1=1
        <if test="baseMap.num!= null and baseMap.num!= ''">
            and   ROWNUM   &lt;= #{baseMap.num}
        </if>
    </select>
    <!--专项和院内项目类型数据维护公共sql-->
    <sql id="CategoryInfo">
        SELECT  ID,
        SPECIAL_NAME,
        SPECIAL_CODE
        FROM   PS_SPECIAL_CATEGORY
        where   1=1
        <if test="categoryMap.specalType!= null and categoryMap.specalType!= ''">
            and   SPECIAL_TYPE  = #{categoryMap.specalType}
        </if>
        <if test="categoryMap.specalCode!= null and categoryMap.specalCode!= ''">
            and   SPECIAL_CODE  = #{categoryMap.specalCode}
        </if>
        <if test="categoryMap.specalName!= null and categoryMap.specalName!= ''">
            and   SPECIAL_NAME  = #{categoryMap.specalName}
        </if>
        ORDER BY  SPECIAL_CODE
    </sql>
    <!--专项和院内项目类型数据维护公共sql-->
    <select id="selectForCapitalCategoryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
            SELECT  SC.ID,
            SC.SPECIAL_NAME,
            SC.SPECIAL_CODE
            FROM   PS_SPECIAL_CATEGORY  SC
            LEFT JOIN  PS_FUNDS_SOURCE  FS ON  SC.SPECIAL_CODE=FS.SPECIAL_COMPANY_CODE
            LEFT JOIN  PS_SPECIAL_CATEGORY  SC1 ON  SC1.SPECIAL_CODE=FS.SPECIAL_EPRI_CODE
            where   1=1
            <if test="categoryMap.specalType!= null and categoryMap.specalType!= ''">
                and   SC.SPECIAL_TYPE  = #{categoryMap.specalType}
            </if>
            <if test="categoryMap.specalCode!= null and categoryMap.specalCode!= ''">
                and   SC.SPECIAL_CODE  = #{categoryMap.specalCode}
            </if>
            <if test="null != categoryMap.epriCodes and categoryMap.epriCodes.size > 0">
                and   FS.SPECIAL_EPRI_CODE IN
                <foreach collection="categoryMap.epriCodes" item="epriCode" open="(" separator="," close=")">
                    #{epriCode,jdbcType=VARCHAR}
                </foreach>
            </if>
            ORDER BY   SC.SPECIAL_CODE
    </select>

    <!-- 专项和院内项目类型的查询-->
    <select id="selectForCategoryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="CategoryInfo"/>)
    </select>



    <!--资金来源维护公共sql-->
    <sql id="FundsSourceInfo">
        SELECT  FS.ID,
        FS.FUNDS_SOURCE_CODE,
        FS.FUNDS_SOURCE_NAME,
        FS.SPECIAL_COMPANY_CODE,
        FS.SPECIAL_EPRI_CODE,
        SC.SPECIAL_CODE,
        SC.SPECIAL_NAME
        FROM   PS_FUNDS_SOURCE  FS
        LEFT JOIN  PS_SPECIAL_CATEGORY SC  ON  SPECIAL_COMPANY_CODE=SC.SPECIAL_CODE
        where   1=1
        <if test="fundsSourceMap.specalType!= null and fundsSourceMap.specalType!= ''">
            and    FS.SPECIAL_COMPANY_CODE  = #{fundsSourceMap.specalType}
        </if>
        <if test="fundsSourceMap.specialName!= null and fundsSourceMap.specialName!= ''">
            and    SC.SPECIAL_NAME  = #{fundsSourceMap.specialName}
        </if>
        <if test="fundsSourceMap.specialCode!= null and fundsSourceMap.specialCode!= ''">
            and    SC.SPECIAL_CODE  = #{fundsSourceMap.specialCode}
        </if>
        <if test="null != fundsSourceMap.epriCodes and fundsSourceMap.epriCodes.size > 0">
            and   FS.SPECIAL_EPRI_CODE IN
            <foreach collection="fundsSourceMap.epriCodes" item="epriCode" open="(" separator="," close=")">
                #{epriCode,jdbcType=VARCHAR}
            </foreach>
        </if>
    ORDER BY  FUNDS_SOURCE_CODE
    </sql>

    <!-- 资金来源的查询-->
    <select id="selectForFundsSourceInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="FundsSourceInfo"/>)
    </select>



    <!--承担单位的查询-->
    <sql id="CommitmentUnitInfo">
        SELECT  DISTINCT
        PROFIT_CENTER_CODE,
        PROFIT_CENTER_DEATIL
        FROM   PS_PROFIT_CENTER
        where  1=1
        <if test="commitmentUnitMap.commitmentUnit!= null and commitmentUnitMap.commitmentUnit!= ''">
            and   PROFIT_CENTER_CODE  = #{commitmentUnitMap.commitmentUnit}
        </if>
    </sql>
    <!-- 基础数据中存在的承担单位的查询-->
    <select id="selectForCommitmentUnitInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     *  from(<include refid="CommitmentUnitInfo"/>)
    </select>


    <select id="selectForDataDictionaryInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT     PID,PCODE,NAME,CODE,SORT_ID  from      BG_SYS_DATADICTIONARY  where 1=1
        <if test="dataDictionaryMap.pcode!= null and dataDictionaryMap.pcode!= ''">
            and   PCODE  = #{dataDictionaryMap.pcode}
        </if>
        <if test="dataDictionaryMap.pid!= null and dataDictionaryMap.pid!= ''">
            and   PID  = #{dataDictionaryMap.pid}
        </if>
        ORDER BY  to_number(SORT_ID)
    </select>


    <!--计划执行数据维护公共sql-->
    <sql id="baseInfo">
        SELECT
        Z1.PSPID,
        Z1.PTIME,
        DECODE(Z1.ZGSZTZ,NUll,0,Z1.ZGSZTZ) ZGSZTZ,
        DECODE(Z1.WERT1,NUll,0,Z1.WERT1) WERT1,
        DECODE(Z1.ZZJXZ,'00001','00001','00002','00002','')as ZZJXZ,
        Z1.ZZJXZ_T,
        Z1.PRCTR,
        ER.SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME  as SPECIAL_COMPANY_NAME
        FROM   PS_ERP_PROJECT_INFO    Z1
        LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
        LEFT JOIN     PS_SPECIAL_CATEGORY  SC  ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
        UNION ALL
        SELECT
        MY.ID  as PSPID,
        MY.YEAR  as  PTIME,
        TO_NUMBER(MY.PLAN_AMOUNT) ZGSZTZ,
        TO_NUMBER(MY.PLAN_AMOUNT)  as  WERT1,
        DECODE(MY.SPECIAL_TYPE, 'C013','00001','C014','00001','C012','00002','') as ZZJXZ,
        DECODE(MY.SPECIAL_TYPE, 'C013','资本化','C014','资本化','C012','成本化','') as  ZZJXZ_T,
        null PRCTR,
        MY.SPECIAL_TYPE   as SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME   as SPECIAL_COMPANY_NAME
        FROM      PS_MAINTAIN_YEAR  MY
        LEFT JOIN    PS_SPECIAL_CATEGORY  SC ON   MY.SPECIAL_TYPE=SC.SPECIAL_CODE
    </sql>
    <!--计划投入-近三年发展投入趋势-->
    <select id="selectForYearAndDevelopInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT
          PTIME as YEAR ,
          ROUND(DECODE(SUM(ZGSZTZ),NUll,0,SUM(ZGSZTZ))/10000, 2) TOTAL_INVEST,
          ROUND(DECODE(SUM(WERT1),NUll,0,SUM(WERT1))/10000, 2) YEAR_INVEST,
          SUM(WERT1) as YEAR_INVEST ,
          COUNT(PSPID) as NUMBER_OF_ITEMS
        from( <include refid="baseInfo"/> )where 1=1
        <if test="baseMap.year!= null and baseMap.year!= ''">
            and   PTIME  = #{baseMap.year}
        </if>
        <if test="baseMap.specialType!= null and baseMap.specialType!= ''">
            and   SPECIAL_COMPANY_CODE  = #{baseMap.specialType}
        </if>
        <if test="baseMap.prctr!= null and baseMap.prctr!= ''">
            and   PRCTR  = #{baseMap.prctr}
        </if>
        GROUP BY  PTIME
        ORDER BY  PTIME
    </select>

    <!--计划投入-资本性和成本性投入趋势-->
    <select id="selectForCostAndCapitalInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT
        PTIME as YEAR ,
        ROUND(DECODE(SUM(ZGSZTZ),NUll,0,SUM(ZGSZTZ))/10000, 2) TOTAL_INVEST,
        ROUND(DECODE(SUM(WERT1),NUll,0,SUM(WERT1))/10000, 2) YEAR_INVEST,
        COUNT(PSPID) as NUMBER_OF_ITEMS,
        ROUND(SUM(DECODE(ZZJXZ,'00001',ZGSZTZ,'0'))/10000, 2) AS CAPITAL_INVEST,
        ROUND(SUM(DECODE(ZZJXZ,'00002',ZGSZTZ,'0'))/10000, 2) AS COST_INVEST
        from( <include refid="baseInfo"/> )where 1=1  and   ZZJXZ IS NOT NULL
        <if test="baseMap.year!= null and baseMap.year!= ''">
            and   PTIME  = #{baseMap.year}
        </if>
        <if test="baseMap.specialType!= null and baseMap.specialType!= ''">
            and   SPECIAL_COMPANY_CODE  = #{baseMap.specialType}
        </if>
        <if test="baseMap.prctr!= null and baseMap.prctr!= ''">
            and   PRCTR  = #{baseMap.prctr}
        </if>
        GROUP BY  PTIME
        ORDER BY  PTIME
    </select>

    <!--计划投入-各专项年度投入情况-->
    <select id="selectForItemInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT  PTIME as  YEAR ,
        SPECIAL_COMPANY_CODE  as  SPECIAL_CODE,
        SPECIAL_COMPANY_NAME as  SPECIAL_NAME ,
        ROUND(DECODE(SUM(ZGSZTZ),NUll,0,SUM(ZGSZTZ))/10000, 2) TOTAL_INVEST,
        ROUND(DECODE(SUM(WERT1),NUll,0,SUM(WERT1))/10000, 2) YEAR_INVEST,
        count(PSPID) as NUMBER_OF_ITEMS
        from(<include refid="baseInfo"/>) where 1=1  and  SPECIAL_COMPANY_CODE IS NOT NULL
        <if test="baseMap.year!= null and baseMap.year!= ''">
            and   PTIME  = #{baseMap.year}
        </if>
        <if test="baseMap.specialType!= null and baseMap.specialType!= ''">
            and   SPECIAL_COMPANY_CODE  = #{baseMap.specialType}
        </if>
        <if test="baseMap.prctr!= null and baseMap.prctr!= ''">
            and   PRCTR  = #{baseMap.prctr}
        </if>
        GROUP BY  PTIME  ,SPECIAL_COMPANY_CODE,SPECIAL_COMPANY_NAME
        ORDER BY   SPECIAL_CODE

    </select>

    <sql id="subTypeBaseInfo">
         SELECT  PTIME as  YEAR ,
         SPECIAL_COMPANY_CODE  as  SPECIAL_CODE,
         SPECIAL_COMPANY_NAME  as  SPECIAL_NAME ,
         SUM(ZGSZTZ)  as TOTAL_INVEST,
         SUM(WERT1) as YEAR_INVEST ,
         count(PSPID) as NUMBER_OF_ITEMS,
         SUM(EXECUTION_PROGRESS) as EXECUTION_PROGRESS,
         ROUND(SUM(EXECUTION_PROGRESS)/count(PSPID), 2)  as ITEM_PROGRESS
        from(
        SELECT
        Z1.PSPID,
        Z1.PTIME,
        ROUND(DECODE(Z1.ZGSZTZ,NUll,0,Z1.ZGSZTZ)/10000, 2)ZGSZTZ,
        ROUND(DECODE(Z1.WERT1,NUll,0,Z1.WERT1)/10000, 2)WERT1,
        Z1.PRCTR,
        ER.SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME  as SPECIAL_COMPANY_NAME,
        DECODE(MP.EXECUTION_PROGRESS,NULL,'0',MP.EXECUTION_PROGRESS)  AS   EXECUTION_PROGRESS
        FROM   PS_ERP_PROJECT_INFO    Z1
        LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
        LEFT JOIN     PS_SPECIAL_CATEGORY  SC  ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
        LEFT JOIN     PS_MAINTAIN_PROJECT  MP ON  MP.PROJECT_ID=Z1.PSPID    AND    MP.YEAR=Z1.PTIME
        UNION ALL
        SELECT
        MY.ID  as PSPID,
        MY.YEAR  as  PTIME,
        0 ZGSZTZ,
        TO_NUMBER(MY.PLAN_AMOUNT)  as  WERT1,
        null PRCTR,
        MY.SPECIAL_TYPE   as SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME   as SPECIAL_COMPANY_NAME,
        DECODE(MP.EXECUTION_PROGRESS,NULL,'0',MP.EXECUTION_PROGRESS) AS   EXECUTION_PROGRESS
        FROM      PS_MAINTAIN_YEAR  MY
        LEFT JOIN    PS_SPECIAL_CATEGORY  SC ON   MY.SPECIAL_TYPE=SC.SPECIAL_CODE
        LEFT JOIN    PS_MAINTAIN_PROJECT  MP ON   MP.PROJECT_ID=MY.ID
        ) where 1=1  and  SPECIAL_COMPANY_CODE IS NOT NULL
        <if test="subTypeMap.prctr!= null and subTypeMap.prctr!= ''">
            and   PRCTR  = #{subTypeMap.prctr}
        </if>
        <if test="subTypeMap.year!= null and subTypeMap.year!= ''">
            and   PTIME  = #{subTypeMap.year}
        </if>
        <if test="subTypeMap.specialCode!= null and subTypeMap.specialCode!= ''">
            and   SPECIAL_COMPANY_CODE  = #{subTypeMap.specialCode}
        </if>
        GROUP BY  PTIME  ,SPECIAL_COMPANY_CODE,SPECIAL_COMPANY_NAME
    </sql>

    <select id="selectSubTypeInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT YEAR,SPECIAL_CODE,SPECIAL_NAME,(case when ITEM_PROGRESS &lt;0 then 0  else  ITEM_PROGRESS  end  )   as  ITEM_PROGRESS
        FROM(<include refid="subTypeBaseInfo"/>)
        WHERE   1=1
        ORDER BY   ITEM_PROGRESS DESC
    </select>



    <sql id="subUnitBaseInfo">
         SELECT  PTIME as  YEAR ,   PRCTR  as  UNIT_CODE  ,PROFIT_CENTER_DEATIL  as  UNIT_NAME ,
           count(PSPID) as NUMBER_OF_ITEMS,SUM(EXECUTION_PROGRESS) as EXECUTION_PROGRESS,
         ROUND(SUM(EXECUTION_PROGRESS)/count(PSPID), 2)  as ITEM_PROGRESS
        from(
        SELECT
        Z1.PSPID,
        Z1.PTIME,
        Z1.PRCTR,
        DECODE(PC.PROFIT_CENTER_DEATIL,NULL,Z1.KTEXT, PC.PROFIT_CENTER_DEATIL)   PROFIT_CENTER_DEATIL,
        ER.SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME  as SPECIAL_COMPANY_NAME,
        DECODE(MP.EXECUTION_PROGRESS,NULL,'0',MP.EXECUTION_PROGRESS)  AS   EXECUTION_PROGRESS
        FROM   PS_ERP_PROJECT_INFO    Z1
        LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
        LEFT JOIN     PS_SPECIAL_CATEGORY  SC  ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
        LEFT JOIN     PS_MAINTAIN_PROJECT  MP ON  MP.PROJECT_ID=Z1.PSPID    AND    MP.YEAR=Z1.PTIME
        LEFT JOIN     ( SELECT  DISTINCT    PROFIT_CENTER_CODE ,PROFIT_CENTER_DEATIL FROM PS_PROFIT_CENTER)   PC  ON PC.PROFIT_CENTER_CODE=Z1.PRCTR
        UNION ALL
        SELECT
        MY.ID  as PSPID,
        MY.YEAR  as  PTIME,
        MY.BEARER PRCTR,
        PC.PROFIT_CENTER_DEATIL,
        MY.SPECIAL_TYPE   as SPECIAL_COMPANY_CODE,
        SC.SPECIAL_NAME   as SPECIAL_COMPANY_NAME,
        DECODE(MP.EXECUTION_PROGRESS,NULL,'0',MP.EXECUTION_PROGRESS) AS   EXECUTION_PROGRESS
        FROM      PS_MAINTAIN_YEAR  MY
        LEFT JOIN    PS_SPECIAL_CATEGORY  SC ON   MY.SPECIAL_TYPE=SC.SPECIAL_CODE
        LEFT JOIN    PS_MAINTAIN_PROJECT  MP ON   MP.PROJECT_ID=MY.ID
        LEFT JOIN     ( SELECT  DISTINCT    PROFIT_CENTER_CODE ,PROFIT_CENTER_DEATIL FROM PS_PROFIT_CENTER)   PC  ON PC.PROFIT_CENTER_CODE=MY.BEARER
        ) where 1=1  and  PRCTR IS NOT NULL
        GROUP BY  PTIME  ,PRCTR,PROFIT_CENTER_DEATIL
    </sql>

    <select id="selectForSubUnitInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
        SELECT  YEAR,UNIT_CODE,UNIT_NAME,(case when ITEM_PROGRESS &lt;0 then  0   else  ITEM_PROGRESS   end  )   as ITEM_PROGRESS
        FROM(<include refid="subUnitBaseInfo"/>)
        WHERE   1=1
        <if test="subUnitMap.year!= null and subUnitMap.year!= ''">
            and   YEAR  = #{subUnitMap.year}
        </if>
        <if test="subUnitMap.unitode!= null and subUnitMap.unitCode!= ''">
            and   UNIT_CODE  = #{subUnitMap.unitCode}
        </if>
        ORDER BY   ITEM_PROGRESS DESC
    </select>


    <!--权限查询-->
    <select id="selectForMainrtainAccessInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
      SELECT   ACCESS_TYPE,DEPT_CODE,USER_CODE  FROM   PS_MAINRTAIN_ACCESS where VALID=1
        <if test="accessMap.userCode!= null and accessMap.userCode!= ''">
            and   USER_CODE  = #{accessMap.userCode}
        </if>
    </select>

    <select id="selectForUserAccessInfo" resultType="java.util.Map" parameterType="java.util.HashMap"  >
            SELECT  DISTINCT PRCTR,SPECIAL_CODE, SPECIAL_NAME   FROM(
            SELECT
            Z1.PTIME ,
            Z1.PRCTR,
            ER.SPECIAL_COMPANY_CODE  as  SPECIAL_CODE ,
            SC.SPECIAL_NAME  ,
            PC.DEPT_CODE
            FROM   PS_ERP_PROJECT_INFO    Z1
            LEFT JOIN     PS_SPECIAL_ERP_RELATION  ER  ON    ER.ERP_SPECIAL_CODE=Z1.PRART1
            LEFT JOIN     PS_SPECIAL_CATEGORY  SC ON  SC.SPECIAL_CODE=ER.SPECIAL_COMPANY_CODE
            LEFT JOIN     PS_PROFIT_CENTER PC ON PC.PROFIT_CENTER_CODE=Z1.PRCTR
            )where  1=1
        <if test="accessMap.deptCode!= null and accessMap.deptCode!= ''">
            and   DEPT_CODE  = #{accessMap.deptCode}
        </if>
        <if test="accessMap.year!= null and accessMap.year!= ''">
            and   PTIME  = #{accessMap.year}
        </if>
        ORDER BY   SPECIAL_CODE
    </select>

</mapper>